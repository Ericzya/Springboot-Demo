<!DOCTYPE html>
<html>
<head>
    <title>Interview Calendar</title>
    <style>
        .cannotSelectText {
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .normalCell {
            height: 30px;
            background-color: #eee;
        }

        .planCell {
            background-color: #9BB3DA;
            border-left: #ff0000 2px solid;
            border-right: #ff0000 2px solid;
        }

        .planCellHeader {
            background-color: #9BB3DA;
            border-top: #ff0000 2px solid;
        }

        .planCellBottom {
            background-color: #9BB3DA;
            border-bottom: #ff0000 2px solid;
        }

        .scheduleTableClass {
            display: inline-block;
        }

        .scheduleTableClass::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<!--import online jquery -->
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">
    let draggedTable_movable = false;
    let planCache = [];
    let planCacheMap = new Map();
    let dragedTable_movedDiv = "dragedTable_movedDiv";
    let currentHourPos = 0;
    let currentDayPos = 0;
    let dragedTable_preCell;

    $(function () {
        showCurrentMonthDays();
    });

    function goToToday() {
        let today = new Date();
        $("#year").val(today.getFullYear());
        $("#month").val(today.getMonth() + 1);
        showCurrentMonthDays(today);
    }

    function goToPreviousMonth() {
        //change month selection
        let month = $("#month");
        let year = $("#year");
        if (parseInt(month.val()) === 1) {
            //limit minimum year selection
            if (parseInt(year.val()) === 2018) {
                alert("Date can't be earlier than 2018.1!");
                return;
            }
            year.val(parseInt(year.val()) - 1);
            month.val(12);
        } else {
            month.val(parseInt(month.val()) - 1);
        }
        //show all days in current month
        showCurrentMonthDays();
    }

    function goToNextMonth() {
        //change month selection
        let month = $("#month");
        let year = $("#year");
        if (parseInt(month.val()) === 12) {
            //limit maximum year selection
            if (parseInt(year.val()) === 2021) {
                alert("Date can't be later than 2021.12!");
                return;
            }
            year.val(parseInt(year.val()) + 1);
            month.val(1);
        } else {
            month.val(parseInt(month.val()) + 1);
        }
        //show all days in current month
        showCurrentMonthDays();
    }

    //show all hours in everyday and print it out
    function showAllHours(scheduleTable, totalDays) {
        for (let i = 0; i < 24; i++) {
            let hourRow = scheduleTable.insertRow();
            let hourCell = hourRow.insertCell();
            hourCell.innerText = i.toString() + ":00";
            for (let j = 1; j <= totalDays; j++) {
                let hourCellInTable = hourRow.insertCell();
                hourCellInTable.className = "normalCell";
                hourCellInTable.id = j.toString() + "-" + i.toString();
                hourCellInTable.onmouseover = function () {
                    $(this).css({"background-color": "#FF4040"});
                };
                hourCellInTable.onmouseout = function () {
                    $(this).css({"background-color": "#eee"});
                };
                if (i === 8 || i === 12 || i === 16) {
                    hourCell.style.borderBottom = "solid";
                    hourCell.style.borderBottomColor = "#000000";
                    hourCell.style.borderWidth = "2px";
                    hourCellInTable.style.borderBottom = "solid";
                    hourCellInTable.style.borderBottomColor = "#000000";
                    hourCellInTable.style.borderWidth = "2px";
                }
            }
        }
    }

    //show all days in current month
    function showCurrentMonthDays(today) {
        //get days' count in current month
        let curDate = new Date($("#year").val());
        curDate.setMonth($("#month").val());
        curDate.setDate(0);
        let totalDays = curDate.getDate();
        let daySelection = document.getElementById("day");
        let scheduleTable = document.getElementById("scheduleTable");
        //reset day selections and table
        scheduleTable.innerHTML = "";
        daySelection.innerHTML = "";
        let tableHeader = scheduleTable.insertRow();
        let introductionCell = tableHeader.insertCell();
        introductionCell.innerText = "Time/Date";
        for (let i = 1; i <= totalDays; i++) {
            //set day selections
            daySelection.options.add(new Option(i.toString(), i.toString()));
            //set table detail
            let cell = tableHeader.insertCell();
            cell.innerText = i.toString();
            cell.style.width = "70px";
        }
        if (today != null) {
            $("#day").val(today.getDate());
        }
        showAllHours(scheduleTable, totalDays);
    }

    //set plans
    function setPlan() {
        let day = $("#day").val();
        let startHour = $("#hour").val();
        let duration = $("#duration").val();
        let plan = $("#plan").val();
        if (duration.trim() === '0') {
            alert("Please choose duration!");
            return;
        }
        //check whether this plan conflicts with other plans or not
        for (let i = startHour; i <= Number(startHour) + Number(duration) - 1; i++) {
            let idStr = day + "-" + i;
            for (let item of planCache) {
                if (item.toString() === idStr.toString()) {
                    alert("This plan conflicts with other plans!");
                    return;
                }
            }
        }
        planCacheMap.set(day + "-" + startHour, duration);
        console.log("now map is:");
        console.log(planCacheMap);
        //set plan area covered with other style
        for (let i = startHour; i <= Number(startHour) + Number(duration) - 1; i++) {
            planCache.push(day + "-" + i);
            let targetCell = document.getElementById(day + "-" + i);
            targetCell.className = "planCell";
            //to reset backgroundColor just in case this cell has been set a backgroundColor already
            targetCell.style.backgroundColor = "#9BB3DA";
            if (Number(i) === Number(startHour)) {
                targetCell.innerText = plan;
                targetCell.className = targetCell.className + " planCellHeader";
            }
            if (Number(i) === Number(startHour) + Number(duration) - 1) {
                targetCell.className = targetCell.className + " planCellBottom";
            }
            targetCell.onmouseover = function () {
                $(this).css({"background-color": "#FF4040"});
            };
            targetCell.onmouseout = function () {
                $(this).css({"background-color": "#9BB3DA"});
            };
        }
    }

    function hideDiv() {
        if (draggedTable_movable) {
            let oTable = document.getElementById("scheduleTable");
            let pos = [];
            if (dragedTable_preCell != null) {
                for (let i = 1; i < oTable.rows.length; i++) {
                    for (let j = 1; j < oTable.rows[i].cells.length - 1; j++) {
                        pos = getPos(oTable.rows[i].cells[j]);
                        //caculate the mouse's position
                        if (event.x > pos[1] && event.x < pos[1] + oTable.rows[i].cells[j].offsetWidth
                            && event.y > pos[0] && event.y < pos[0] + oTable.rows[i].cells[j].offsetHeight) {
                            //switch text
                            dragedTable_preCell.innerHTML = oTable.rows[i].cells[j].innerHTML;
                            oTable.rows[i].cells[j].innerHTML = document.all(dragedTable_movedDiv).innerHTML;
                            //reset styles
                            dragedTable_preCell.style.backgroundColor = '#eee';
                            oTable.rows[i].cells[j].style.backgroundColor = '#eee';
                            oTable.rows[i].cells[j].style.cursor = "";
                            dragedTable_preCell.style.cursor = "";
                            dragedTable_preCell.style.backgroundColor = '#eee';
                        }
                    }
                }
            }
            draggedTable_movable = false;
            //clear notice layer
            document.all(dragedTable_movedDiv).style.display = "none";
        }
    }

    function dragDiv() {
        if (draggedTable_movable) {
            let pos = [];
            let oTable = document.getElementById("scheduleTable");
            for (let i = 1; i < oTable.rows.length; i++) {
                for (let j = 1; j < oTable.rows[i].cells.length - 1; j++) {
                    pos = getPos(oTable.rows[i].cells[j]);
                    if (event.x > pos[1] && event.x < pos[1] + oTable.rows[i].cells[j].offsetWidth
                        && event.y > pos[0] && event.y < pos[0] + oTable.rows[i].cells[j].offsetHeight) {
                        if (oTable.rows[i].cells[j] != dragedTable_preCell) {
                            let hourPos = i;
                            let dayPos = j;
                            let duration = 1;
                            let ifExist = false;
                            let ifConflict = false;
                            if (planCache.length > 0) {
                                for (let z = 0; z < planCache.length - 1; z++) {
                                    let item = planCache[z];
                                    let idStr = currentDayPos + '-' + currentHourPos;
                                    let currentPosStr = j + '-' + i;
                                    if (currentPosStr.toString() === item.toString()) {
                                        ifConflict = true;
                                        break;
                                    }
                                    if (item.toString() === idStr.toString()) {
                                        ifExist = true;
                                        break;
                                    }
                                }
                            }
                            if (ifConflict) {
                                continue;
                            }
                            let startPos = -1;
                            //match the records in planCacheMap
                            for (let tempPos = currentHourPos; tempPos >= 0; tempPos--) {
                                //remove target values in planCache and planCacheMap
                                console.log("judge:" + currentDayPos + '-' + tempPos);
                                if (planCacheMap.has(currentDayPos + '-' + tempPos)) {
                                    console.log("enter");
                                    startPos = tempPos;
                                    hourPos = i;
                                    duration = planCacheMap.get(currentDayPos + '-' + tempPos);
                                    console.log("deleteMap" + currentDayPos + '-' + tempPos);
                                    planCacheMap.delete(currentDayPos + '-' + tempPos);
                                    //current tempPos is the min value of list,so we can delete values in planCache in asc order
                                    for (let tempIndex = 0; tempIndex < planCache.length - 1; tempIndex++) {
                                        for (let durationIndex = 0; durationIndex < duration; durationIndex++) {
                                            console.log("---delete");
                                            console.log("duration:" + duration);
                                            console.log(planCache);
                                            console.log(currentDayPos + '-' + (Number(tempPos) + Number(durationIndex)));
                                            if (planCache[tempIndex] === currentDayPos + '-' + (Number(tempPos) + Number(durationIndex))) {
                                                planCache.splice(tempIndex, 1);
                                            }
                                        }
                                    }
                                    break;
                                }
                            }
                            //remove style of the cells selected before
                            if (startPos != -1) {
                                for (let tempIndex = 0; tempIndex < duration; tempIndex++) {
                                    let targetCell = document.getElementById(currentDayPos + '-' + (Number(startPos) + Number(tempIndex)));
                                    targetCell.className = "normalCell";
                                    targetCell.onmouseover = null;
                                    targetCell.onmouseout = null;
                                }
                            }
                            //set current cell in selected status
                            for (let a = 0; a <= duration - 1; a++) {
                                planCache.push(j + '-' + Number(hourPos + a - 1));
                                let currentCell = oTable.rows[Number(hourPos) + Number(a)].cells[j];
                                currentCell.className = "planCell";
                                currentCell.style.backgroundColor = '#9BB3DA';
                                if (Number(hourPos) + Number(a) === Number(hourPos)) {
                                    currentCell.className = currentCell.className + " planCellHeader";
                                }
                                if (Number(hourPos) + Number(a) === Number(hourPos) + Number(duration) - 1) {
                                    currentCell.className = currentCell.className + " planCellBottom";
                                }
                                currentCell.onmouseover = function () {
                                    $(this).css({"background-color": "#FF4040"});
                                };
                                currentCell.onmouseout = function () {
                                    $(this).css({"background-color": "#9BB3DA"});
                                };
                            }
                            planCacheMap.set(j + '-' + Number(hourPos - 1), duration);
                            console.log('after');
                            console.log(planCache);
                            console.log(planCacheMap);

                        }
                    } else {
                        if (oTable.rows[i].cells[j] != dragedTable_preCell)
                            oTable.rows[i].cells[j].style.backgroundColor = '#eee';
                    }
                }
            }
        }
    }

    //get cell's position
    function getPos(cell) {
        let pos = [];
        let t = cell.offsetTop;
        let l = cell.offsetLeft;
        while (cell = cell.offsetParent) {
            t += cell.offsetTop;
            l += cell.offsetLeft;
        }
        pos[0] = t;
        pos[1] = l;
        return pos;
    }

    //regist dragedable table
    function DraggedTable() {
        let oTempDiv = document.createElement("div");
        oTempDiv.id = dragedTable_movedDiv;
        oTempDiv.onselectstart = function () {
            return false
        };
        oTempDiv.style.cursor = "hand";
        oTempDiv.style.position = "absolute";
        oTempDiv.style.border = "1px solid black";
        oTempDiv.style.backgroundColor = '#9BB3DA';
        oTempDiv.style.display = "none";
        document.body.appendChild(oTempDiv);
        document.getElementById("scheduleTable").onmousedown = showDiv;
    }

    //show layer
    function showDiv(targetObj) {
        let idStr = targetObj.target.id;
        if (idStr == null) {
            return;
        }
        let strArr = idStr.split("-");
        currentDayPos = strArr[0];
        currentHourPos = strArr[1];
        let obj = event.srcElement;
        let pos = [];
        //get temp layer
        let oDiv = document.all(dragedTable_movedDiv);
        if (obj.tagName.toLowerCase() == "td") {
            obj.style.cursor = "hand";
            pos = getPos(obj);
            //caculate mid layer position
            oDiv.style.width = obj.offsetWidth;
            oDiv.style.height = obj.offsetHeight;
            oDiv.style.top = pos[0];
            oDiv.style.left = pos[1];
            oDiv.innerHTML = obj.innerHTML;
            oDiv.style.display = "";
            obj.style.backgroundColor = '#eee';
            dragedTable_preCell = obj;
            draggedTable_movable = true;
        }
    }

    //init table
    function init() {
        new DraggedTable();
    }

    //set mouse move event
    document.onmousemove = function () {
        dragDiv();
    }

    //set mouse up event
    document.onmouseup = function () {
        hideDiv();
        //reset all scheduled cells' color
        for (let item of planCache) {
            document.getElementById(item).style.backgroundColor="#9BB3DA";
        }
    }
</script>
<body onload="init()">
<div style="padding: 5px;" class="cannotSelectText">
    <div style="padding: 10px;display: inline-block;">
        <button onclick="goToToday()">Today</button>
        <button onclick="goToPreviousMonth()"><</button>
        <span>Year</span>
        <select id="year" name="year" onclick="showCurrentMonthDays()">
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
        </select>
        <span>Month</span>
        <select id="month" name="month" onclick="showCurrentMonthDays()">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
        </select>
        <button onclick="goToNextMonth()">></button>
        <span>Day</span>
        <select id="day" name="day">

        </select>
        <span>Hour</span>
        <select id="hour" name="hour">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
        </select>
        <span style="padding-left: 40px;">Duration:</span>
        <select id="duration" name="duration">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
        </select>
        <span>hours</span>
        <span style="padding-left: 40px;">Plan:</span>
        <input id="plan" style="width: 200px"/>
        <button style="margin-left: 40px" onclick="setPlan()">Confirm</button>
    </div>
    <div style="margin-top: 5px;width: 100%;box-sizing: border-box;overflow: scroll;white-space: nowrap;">
        <table id="scheduleTable" class="scheduleTableClass">

        </table>
    </div>
</div>
</body>

</html>
